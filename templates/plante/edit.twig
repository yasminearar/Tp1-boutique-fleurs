{% extends "layouts/base.twig" %}

{% block title %}Modifier {{ plante.nom }} - Fleurs & Plantes{% endblock %}

{% block stylesheets %}
<link rel="stylesheet" href="{{ ASSETS_URL }}/css/file-upload.css">
{% endblock %}

{% block content %}
    <div class="breadcrumb">
        <a href="{{ BASE_URL }}/"><i class="fas fa-home"></i> Accueil</a> &gt;
        <a href="{{ BASE_URL }}/plantes"><i class="fas fa-leaf"></i> Plantes</a> &gt;
        <a href="{{ BASE_URL }}/plante/{{ plante.id }}">{{ plante.nom }}</a> &gt;
        <span>Modifier</span>
    </div>

    <div class="page-header">
        <h2><i class="fas fa-edit"></i> Modifier la plante</h2>
        <div class="page-header-actions">
            <a href="{{ BASE_URL }}/plante/{{ plante.id }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Retour aux détails
            </a>
        </div>
    </div>    <div class="form-container">
        <form action="{{ BASE_URL }}/plante/{{ plante.id }}/update" method="post" enctype="multipart/form-data" class="form">
            {% if errors is defined and errors|length > 0 %}
                <div class="alert alert-danger">
                    <h4><i class="fas fa-exclamation-triangle"></i> Erreurs dans le formulaire</h4>
                    <ul class="error-list">
                        {% for field, error in errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}            <div class="form-row">
                <div class="form-group col-md-8">
                    <label for="nom" class="form-label-lg mb-2">Nom de la plante *</label>
                    <input type="text" id="nom" name="nom" class="form-control form-control-lg py-3" style="height: auto; font-size: 1.1rem;" value="{{ plante.nom }}" required>
                </div><div class="form-group col-md-4">
                    <label for="id_categorie" class="form-label-lg mb-2">Catégorie *</label>
                    <select id="id_categorie" name="id_categorie" class="form-control custom-select form-control-lg py-3" style="height: auto; font-size: 1.1rem;" required>
                        <option value="">Sélectionnez une catégorie</option>
                        {% for cat in categories %}
                            <option value="{{ cat.id }}" {% if plante.id_categorie == cat.id %}selected{% endif %} style="padding: 8px 0;">
                                {{ cat.nom }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>            <div class="form-group">
                <label for="description" class="form-label-lg mb-2">Description</label>
                <textarea id="description" name="description" class="form-control form-control-lg" rows="5" style="font-size: 1.1rem;">{{ plante.description }}</textarea>
                <small class="form-text text-muted">Décrivez les caractéristiques de la plante, ses besoins en eau et en lumière...</small>
            </div>

            <div class="form-row">                <div class="form-group col-md-6">
                    <label for="prix" class="form-label-lg mb-2">Prix ($) *</label>
                    <div class="input-group">
                        <input type="number" id="prix" name="prix" class="form-control form-control-lg py-3" style="height: auto; font-size: 1.1rem;" value="{{ plante.prix }}" step="0.01" min="0" required>
                        <div class="input-group-append">
                            <span class="input-group-text" style="height: auto; font-size: 1.1rem;">$</span>
                        </div>
                    </div>
                </div>

                <div class="form-group col-md-6">
                    <label for="stock" class="form-label-lg mb-2">Stock *</label>
                    <div class="input-group">
                        <input type="number" id="stock" name="stock" class="form-control form-control-lg py-3" style="height: auto; font-size: 1.1rem;" value="{{ plante.stock }}" min="0" required>
                        <div class="input-group-append">
                            <span class="input-group-text" style="height: auto; font-size: 1.1rem;">unité(s)</span>
                        </div>
                    </div>
                </div>
            </div>            <div class="form-group">
                <label for="image_upload" class="form-label-lg mb-2">Image</label>
                <div class="image-upload-container">
                    {% if plante.image %}
                        <div class="current-image mb-3">
                            <p>Image actuelle :</p>
                            <div class="image-preview">
                                <img src="{{ ASSETS_URL }}/images/plantes/{{ plante.image }}" alt="{{ plante.nom }}">
                            </div>
                            <input type="hidden" name="current_image" value="{{ plante.image }}">
                        </div>
                    {% endif %}
                    
                    <div class="custom-file-upload">
                        <input type="file" id="image_upload" name="image_upload" class="form-control-file" accept="image/*">
                        <small class="form-text text-muted">Formats acceptés: JPG, JPEG, PNG, GIF - Max 2 Mo</small>
                        <div class="form-check mt-2">
                            <input type="checkbox" class="form-check-input" id="keep_current_image" name="keep_current_image" checked>
                            <label class="form-check-label" for="keep_current_image">Conserver l'image actuelle si aucune nouvelle image n'est téléchargée</label>
                        </div>
                    </div>
                    
                    <div class="form-check mt-2">
                        <input type="checkbox" class="form-check-input" id="use_existing_image" name="use_existing_image">
                        <label class="form-check-label" for="use_existing_image">Utiliser une autre image existante</label>
                    </div>
                    
                    <div id="existing_image_input" class="mt-2" style="display: none;">
                        <input type="text" id="image" name="image" class="form-control form-control-lg py-3" style="height: auto; font-size: 1.1rem;" value="{{ plante.image }}" 
                               placeholder="nom-fichier.jpg">
                        <small class="form-text text-muted">L'image doit être dans le dossier public/images/plantes/</small>
                    </div>
                </div>
            </div>

            <div class="form-separator"></div>            <div class="form-actions">
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-check"></i> Mettre à jour
                </button>
                <a href="{{ BASE_URL }}/plante/{{ plante.id }}" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Annuler
                </a>
            </div>
        </form>
    </div>
{% endblock %}

{% block javascripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const useExistingImage = document.getElementById('use_existing_image');
        const existingImageInput = document.getElementById('existing_image_input');
        const imageUpload = document.getElementById('image_upload');
        const keepCurrentImage = document.getElementById('keep_current_image');
        
        useExistingImage.addEventListener('change', function() {
            if(this.checked) {
                existingImageInput.style.display = 'block';
                imageUpload.disabled = true;
                if(keepCurrentImage) keepCurrentImage.checked = false;
            } else {
                existingImageInput.style.display = 'none';
                imageUpload.disabled = false;
                if(keepCurrentImage) keepCurrentImage.checked = true;
            }
        });
        
        if(imageUpload) {
            imageUpload.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    if(keepCurrentImage) keepCurrentImage.checked = false;
                    if(useExistingImage) useExistingImage.checked = false;
                    if(existingImageInput) existingImageInput.style.display = 'none';
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        // Créer ou mettre à jour la prévisualisation
                        let preview = document.querySelector('.current-image');
                        
                        if (!preview) {
                            preview = document.createElement('div');
                            preview.className = 'current-image mb-3';
                            preview.innerHTML = `
                                <p>Aperçu de la nouvelle image :</p>
                                <div class="image-preview">
                                    <img src="${e.target.result}" alt="Prévisualisation">
                                </div>
                            `;
                            document.querySelector('.image-upload-container').insertBefore(preview, document.querySelector('.custom-file-upload'));
                        } else {
                            preview.querySelector('p').textContent = 'Aperçu de la nouvelle image :';
                            const img = preview.querySelector('img');
                            img.src = e.target.result;
                        }
                    }
                    reader.readAsDataURL(file);
                }
            });
        }
    });
</script>
{% endblock %}
